<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' http://127.0.0.1:8787;
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data:;
                 connect-src 'self' http://127.0.0.1:8787;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AURORA Local Agent MVP</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background: #0b0f17; color: #e7eefc; }
    header { padding: 14px 18px; display:flex; align-items:center; justify-content:space-between; border-bottom: 1px solid rgba(255,255,255,.08); }
    .badge { font-size: 12px; opacity: .75; }
    .wrap { display:grid; grid-template-columns: 380px 1fr; height: calc(100vh - 52px); }
    .panel { border-right: 1px solid rgba(255,255,255,.08); padding: 14px; overflow:auto; }
    .main { padding: 14px; display:flex; flex-direction:column; gap:10px; }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 12px; }
    label { display:block; font-size: 12px; opacity: .85; margin-bottom: 6px; }
    input, textarea { width:100%; box-sizing:border-box; border-radius: 10px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.25); color:#e7eefc; padding: 10px; outline:none; }
    textarea { min-height: 90px; resize: vertical; }
    button { cursor:pointer; border-radius: 12px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.08); color:#e7eefc; padding: 10px 12px; }
    button:hover { background: rgba(255,255,255,.12); }
    .chatlog { flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; }
    .bubble { padding: 10px 12px; border-radius: 14px; border:1px solid rgba(255,255,255,.10); white-space: pre-wrap; }
    .u { background: rgba(80,120,255,.12); align-self:flex-end; max-width: 76%; }
    .a { background: rgba(255,255,255,.06); align-self:flex-start; max-width: 76%; }
    .muted { opacity:.75; font-size:12px; }
    
    /* Memory Panel Styles */
    .memory-item { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.06); border-radius: 8px; padding: 6px 8px; margin-bottom: 4px; transition: all 0.2s; }
    .memory-item:hover { background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.12); }
    .memory-content { font-size: 12px; margin-bottom: 3px; line-height: 1.3; }
    .memory-meta { font-size: 10px; opacity: 0.6; display: flex; gap: 6px; flex-wrap: wrap; }
    .memory-tag { background: rgba(80,120,255,.2); padding: 1px 4px; border-radius: 3px; font-size: 9px; }
    .memory-tag.emotion { background: rgba(255,100,100,.2); }
    .memory-tag.topic { background: rgba(100,200,100,.2); }
    .entity-item { background: rgba(255,200,100,.1); border: 1px solid rgba(255,200,100,.2); border-radius: 6px; padding: 5px 6px; margin-bottom: 4px; }
    .entity-name { font-weight: 600; font-size: 12px; }
    .entity-type { font-size: 10px; opacity: 0.6; }
    .relation-item { font-size: 11px; padding: 4px 6px; background: rgba(100,200,255,.1); border-radius: 4px; margin-bottom: 3px; }
    .tab-buttons { display: flex; gap: 6px; margin-bottom: 10px; }
    .tab-btn { flex: 1; text-align: center; padding: 8px; border-radius: 8px; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); cursor: pointer; font-size: 12px; }
    .tab-btn.active { background: rgba(80,120,255,.2); border-color: rgba(80,120,255,.4); }
    .stat-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,.06); font-size: 12px; }
    .importance-bar { height: 2px; background: rgba(255,255,255,.1); border-radius: 1px; overflow: hidden; margin-top: 2px; }
    .importance-fill { height: 100%; background: linear-gradient(90deg, #4080ff, #80c0ff); }
    /* Modal window styles */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.7); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: #0b0f17; border: 1px solid rgba(255,255,255,.12); border-radius: 16px; width: 90%; height: 90%; max-width: 900px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,.6); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,.08); }
    .modal-header h2 { margin: 0; font-size: 18px; font-weight: 700; }
    .modal-close { cursor: pointer; font-size: 24px; opacity: 0.6; }
    .modal-close:hover { opacity: 1; }
    .modal-body { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px 20px; }
    /* Custom scrollbar styles (modal only) */
    .modal-body::-webkit-scrollbar { width: 8px; }
    .modal-body::-webkit-scrollbar-track { background: rgba(255,255,255,.04); border-radius: 4px; }
    .modal-body::-webkit-scrollbar-thumb { background: rgba(80,120,255,.4); border-radius: 4px; }
    .modal-body::-webkit-scrollbar-thumb:hover { background: rgba(80,120,255,.6); }
    /* Conversation list styles */
    .conversation-item { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 10px; padding: 12px 14px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
    .conversation-item:hover { background: rgba(80,120,255,.15); border-color: rgba(80,120,255,.3); }
    .conversation-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conversation-meta { font-size: 11px; opacity: 0.6; display: flex; gap: 12px; }
    .conversation-preview { margin-top: 8px; padding: 10px; background: rgba(0,0,0,.2); border-radius: 8px; max-height: 300px; overflow-y: auto; }
    .preview-message { padding: 8px 10px; margin-bottom: 6px; border-radius: 8px; font-size: 13px; line-height: 1.5; }
    .preview-message.user { background: rgba(80,120,255,.15); margin-left: 20%; }
    .preview-message.assistant { background: rgba(255,255,255,.08); margin-right: 20%; }
    .preview-message .role { font-size: 10px; opacity: 0.6; margin-bottom: 4px; text-transform: uppercase; }
  </style>
</head>
<body>
  <header>
    <div>
      <div style="font-weight:700;">AURORA Local Agent MVP</div>
      <div class="badge">Local-only • Backend: 127.0.0.1:8787 • Version <span id="ver"></span></div>
    </div>
    <div class="badge">Tip: Start backend first, then open chat.</div>
  </header>

  <div class="wrap">
    <aside class="panel">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" id="settings-toggle">
          <div style="font-weight:700;">[SETTINGS] Settings</div>
          <span id="settings-arrow">▼</span>
        </div>
        <div id="settings-content" style="display:none; margin-top:10px;">
          <div class="muted" style="margin-bottom:10px;">Enter OpenAI-compatible base_url / api_key / model (stored locally only).</div>

          <label>Base URL (e.g. https://api.openai.com)</label>
          <input id="base_url" placeholder="https://api.openai.com" />

          <label style="margin-top:10px;">API Key (leave empty to keep existing key)</label>
          <input id="api_key" type="password" placeholder="Leave empty to skip" />

          <label style="margin-top:10px;">Model</label>
          <select id="model" style="width:100%; box-sizing:border-box; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#e7eefc; padding:10px;">
            <option value="">-- Select Model --</option>
            <optgroup label="OpenAI">
              <option value="gpt-4o">gpt-4o</option>
              <option value="gpt-4o-mini">gpt-4o-mini</option>
              <option value="gpt-4-turbo">gpt-4-turbo</option>
              <option value="gpt-4">gpt-4</option>
              <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
            </optgroup>
            <optgroup label="Claude">
              <option value="claude-3-opus-20240229">claude-3-opus</option>
              <option value="claude-3-sonnet-20240229">claude-3-sonnet</option>
              <option value="claude-3-haiku-20240307">claude-3-haiku</option>
              <option value="claude-3-5-sonnet-20241022">claude-3.5-sonnet</option>
            </optgroup>
            <optgroup label="DeepSeek">
              <option value="deepseek-chat">deepseek-chat</option>
              <option value="deepseek-reasoner">deepseek-reasoner</option>
            </optgroup>
            <optgroup label="Other">
              <option value="custom">Custom...
            </optgroup>
          </select>
          <input id="model_custom" placeholder="Enter custom model name" style="display:none; margin-top:6px;" />

          <div style="display:flex; gap:10px; margin-top:12px;">
            <button id="save">Save All</button>
            <button id="save-model">Update Model Only</button>
            <button id="health">Health</button>
          </div>
        </div>
        <div id="status" class="muted" style="margin-top:10px;"></div>
      </div>

      <!-- System Prompt Panel -->
      <div class="card" style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:700;">[SYSTEM] System Prompt</div>
        </div>
        <button id="open-system-prompt-window" style="width:100%; margin-top:10px; padding:12px; font-size:14px;">Edit System Prompt</button>
      </div>

      <!-- Conversation History Panel -->
      <div class="card" style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:700;">[HISTORY] Chat History</div>
        </div>
        <button id="open-conversations-window" style="width:100%; margin-top:10px; padding:12px; font-size:14px;">Load Conversation History</button>
      </div>

      <!-- Memory Panel (Modal/Popup Mode) -->
      <div class="card" style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:700;">[MEMORY] Memory</div>
        </div>
        <button id="open-memory-window" style="width:100%; margin-top:10px; padding:12px; font-size:14px;">Open Memory Window</button>
      </div>
    </aside>

    <!-- System Prompt Modal Window -->
    <div id="system-prompt-modal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h2>[SYSTEM] System Prompt</h2>
          <span class="modal-close" id="close-system-prompt-modal">&times;</span>
        </div>
        <div class="modal-body">
          <div class="muted" style="margin-bottom:12px; font-size:12px;">Choose an AI personality preset or create a custom one</div>
          
          <!-- Template Selection -->
          <div style="margin-bottom:16px;">
            <label style="font-size:12px; margin-bottom:6px; display:block; font-weight:600;">AI Personality</label>
            <select id="system-prompt-template-select" style="width:100%; padding:10px; border-radius:6px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#e7eefc; font-size:13px; outline:none; cursor:pointer;">
            </select>
            <div id="template-status" class="muted" style="margin-top:6px; font-size:11px;"></div>
          </div>
          
          <!-- Custom Prompt Input (shown when custom selected) -->
          <div id="custom-prompt-section" style="display:none;">
            <label style="font-size:12px; margin-bottom:6px; display:block;">Your Custom Prompt</label>
            <textarea id="system-prompt-input" placeholder="Enter your custom AI personality here..." style="width:100%; min-height:300px; max-height:500px; font-size:13px; box-sizing:border-box; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#e7eefc; padding:12px; outline:none; font-family: monospace; resize: vertical;"></textarea>
            
            <label style="font-size:12px; margin-bottom:6px; display:block; margin-top:12px;">Name this personality (optional)</label>
            <input id="custom-prompt-name" type="text" placeholder="e.g., My Friendly Bot" style="width:100%; padding:10px; border-radius:6px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#e7eefc; font-size:13px; outline:none; box-sizing:border-box;">
            
            <div style="display:flex; gap:10px; margin-top:12px;">
              <button id="save-system-prompt" style="flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(80,120,255,.2); color:#e7eefc; font-size:13px; cursor:pointer;">Save</button>
              <button id="reset-system-prompt" style="flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,.08); color:#e7eefc; font-size:13px; cursor:pointer;">Clear</button>
            </div>
          </div>
          
          <div id="system-prompt-status" class="muted" style="margin-top:10px; font-size:11px;"></div>
        </div>
      </div>
    </div>

    <!-- Conversations Modal Window -->
    <div id="conversations-modal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h2>[HISTORY] Conversation History</h2>
          <span class="modal-close" id="close-conversations-modal">&times;</span>
        </div>
        <div class="modal-body">
          <!-- Search bar -->
          <div style="margin-bottom:12px;">
            <input id="conversation-search" type="text" placeholder="Search conversations..." style="width:100%; box-sizing:border-box; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#e7eefc; padding:10px; outline:none;" />
          </div>
          
          <!-- Conversation list -->
          <div id="conversation-list" style="max-height: 60vh; overflow-y: auto;">
            <div class="muted" style="text-align:center; padding:30px;">Loading conversations...</div>
          </div>
          
          <!-- Status -->
          <div id="conversation-status" class="muted" style="margin-top:10px; font-size:11px;"></div>
        </div>
      </div>
    </div>

    <!-- Memory Modal Window -->
    <div id="memory-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>[MEMORY] Memory</h2>
          <span class="modal-close" id="close-memory-modal">&times;</span>
        </div>
        <div class="modal-body">
          <!-- Plugin Selection -->
          <div style="margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,.08);">
            <label style="font-size:12px; margin-bottom:4px; display:block;">[PLUGIN] Memory Plugin</label>
            <select id="memory-plugin-select" style="width:100%; box-sizing:border-box; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#e7eefc; padding:8px; font-size:12px; margin-bottom:8px;">
              <option value="">Loading...</option>
            </select>
            <div id="plugin-info" class="muted" style="font-size:11px; padding:6px; background:rgba(255,255,255,.04); border-radius:4px; margin-bottom:8px;"></div>
            <div id="plugin-features" style="display:flex; gap:4px; flex-wrap:wrap;"></div>
          </div>
          
          <!-- Tab Switching -->
          <div class="tab-buttons">
            <div class="tab-btn active" data-tab="memories">Memories</div>
            <div class="tab-btn" data-tab="entities">Entities</div>
            <div class="tab-btn" data-tab="stats">Stats</div>
            <button id="refresh-memory" style="padding:8px 12px; font-size:12px; flex:0.5;">Refresh</button>
          </div>

          <!-- Memory List -->
          <div id="memories-tab" class="tab-content">
            <div id="memory-list">
              <div class="muted" style="text-align:center; padding:30px;">Click refresh to load memories...</div>
            </div>
          </div>

          <!-- Entity List -->
          <div id="entities-tab" class="tab-content" style="display:none;">
            <div id="entity-list">
              <div class="muted" style="text-align:center; padding:30px;">No entities found...</div>
            </div>
            <div style="margin-top:12px;">
              <div style="font-weight:600; font-size:12px; margin-bottom:8px;">Knowledge Graph</div>
              <div id="relation-list">
                <div class="muted" style="text-align:center; padding:15px;">No relationships...</div>
              </div>
            </div>
          </div>

          <!-- Statistics -->
          <div id="stats-tab" class="tab-content" style="display:none;">
            <div id="memory-stats">
              <div class="muted" style="text-align:center; padding:30px;">Loading...</div>
            </div>
          </div>
          
          <!-- Add Memory -->
          <div style="margin-top:16px; padding-top:12px; border-top:1px solid rgba(255,255,255,.08);">
            <div style="font-weight:600; font-size:13px; margin-bottom:8px;">Add Memory</div>
            <textarea id="new-memory" placeholder="Enter memory content (split by newline)..." style="width:100%; min-height:60px; font-size:12px; box-sizing:border-box; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#e7eefc; padding:8px; outline:none;"></textarea>
            <div style="display:flex; gap:6px; margin-top:8px;">
              <input id="memory-tags" placeholder="Tags (comma separated)" style="flex:1; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#e7eefc; font-size:12px; outline:none;" />
              <input id="memory-importance" type="number" min="0" max="1" step="0.1" value="0.5" style="width:70px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#e7eefc; font-size:12px; outline:none;" />
            </div>
            <div style="display:flex; gap:6px; margin-top:8px;">
              <button id="add-memory" style="flex:1; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(80,120,255,.2); color:#e7eefc; font-size:12px; cursor:pointer;">Add</button>
              <button id="add-demo" style="flex:1; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.08); color:#e7eefc; font-size:12px; cursor:pointer;">Demo</button>
              <button id="clear-memory" style="padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(255,80,80,.2); color:#e7eefc; font-size:12px; cursor:pointer;">Clear</button>
            </div>
            <div id="memory-status" class="muted" style="margin-top:8px; font-size:11px;"></div>
          </div>
        </div>
      </div>
    </div>

    <main class="main">
      <div class="chatlog" id="chatlog"></div>

      <div class="card">
        <label>Message</label>
        <textarea id="msg" placeholder="Say something... (start backend first)"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button id="send">Send</button>
          <button id="clear">Clear</button>
        </div>
        <div id="meta" class="muted" style="margin-top:10px;"></div>
      </div>
    </main>
  </div>

<script>
  document.getElementById("ver").textContent = (window.aurora && window.aurora.version) ? window.aurora.version : "0.1.0";
  const chatlog = document.getElementById("chatlog");
  const status = document.getElementById("status");
  const meta = document.getElementById("meta");

  // Settings collapse/expand toggle
  document.getElementById("settings-toggle").onclick = () => {
    const content = document.getElementById("settings-content");
    const arrow = document.getElementById("settings-arrow");
    if (content.style.display === "none") {
      content.style.display = "block";
      arrow.textContent = "▲";
    } else {
      content.style.display = "none";
      arrow.textContent = "▼";
    }
  };


  function addBubble(text, who) {
    const div = document.createElement("div");
    div.className = "bubble " + (who === "user" ? "u" : "a");
    div.textContent = text;
    chatlog.appendChild(div);
    chatlog.scrollTop = chatlog.scrollHeight;
  }

  // API function to call backend endpoints
  async function api(path, method="GET", body=null) {
    const url = "http://127.0.0.1:8787" + path;
    const opt = { method, headers: { "Content-Type": "application/json" } };
    if (body) opt.body = JSON.stringify(body);
    const res = await fetch(url, opt);
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function loadSettings() {
    try {
      const s = await api("/settings");
      document.getElementById("base_url").value = s.base_url || "";
      document.getElementById("api_key").value = "";
      // Set model dropdown menu
      const modelSelect = document.getElementById("model");
      const modelCustom = document.getElementById("model_custom");
      const savedModel = s.model || "";
      // Check if preset model
      let found = false;
      for (let opt of modelSelect.options) {
        if (opt.value === savedModel) {
          modelSelect.value = savedModel;
          found = true;
          break;
        }
      }
      if (!found && savedModel) {
        modelSelect.value = "custom";
        modelCustom.style.display = "block";
        modelCustom.value = savedModel;
      }
      status.textContent = "Loaded settings (api_key hidden)";
    } catch (e) {
      status.textContent = "Backend not connected. Please start the backend.";
    }
  }

  // Model dropdown: show input when 'custom' is selected
  document.getElementById("model").onchange = () => {
    const modelSelect = document.getElementById("model");
    const modelCustom = document.getElementById("model_custom");
    if (modelSelect.value === "custom") {
      modelCustom.style.display = "block";
      modelCustom.focus();
    } else {
      modelCustom.style.display = "none";
      modelCustom.value = "";
    }
  };

  // Get currently selected model
  function getSelectedModel() {
    const modelSelect = document.getElementById("model");
    const modelCustom = document.getElementById("model_custom");
    if (modelSelect.value === "custom") {
      return modelCustom.value.trim();
    }
    return modelSelect.value;
  }

  document.getElementById("save").onclick = async () => {
    const status = document.getElementById("status");
    try {
      const base_url = document.getElementById("base_url").value.trim();
      const api_key = document.getElementById("api_key").value.trim();
      const model = getSelectedModel();
      if (!base_url || !model) {
        status.textContent = "Please fill in Base URL and Model";
        return;
      }
      status.textContent = "Saving...";
      // If api_key is empty, get the old one
      let finalApiKey = api_key;
      if (!finalApiKey) {
        const old = await api("/settings");
        finalApiKey = old.api_key === "********" ? "" : old.api_key;
        if (!finalApiKey) {
          status.textContent = "First setup requires filling in API Key";
          return;
        }
      }
      await api("/settings", "POST", { base_url, api_key: finalApiKey || api_key, model, provider: "openai_compatible" });
      status.textContent = "All settings saved successfully!";
    } catch (e) {
      status.textContent = "Save failed: " + e.message;
    }
  };

  document.getElementById("save-model").onclick = async () => {
    const status = document.getElementById("status");
    try {
      const model = getSelectedModel();
      if (!model) {
        status.textContent = "Please select a model";
        return;
      }
      status.textContent = "Updating model...";
      await api("/settings/model", "POST", { model });
      status.textContent = "Model updated to: " + model;
    } catch (e) {
      status.textContent = "Failed to update model: " + e.message;
    }
  };

  document.getElementById("health").onclick = async () => {
    const status = document.getElementById("status");
    try {
      status.textContent = "Checking...";
      const result = await api("/health");
      status.textContent = "Backend OK: " + JSON.stringify(result);
    } catch (e) {
      status.textContent = "Backend connection failed: " + e.message;
    }
  };

  // Send message function
  async function sendMessage() {
    const msg = document.getElementById("msg").value.trim();
    if (!msg) return;
    document.getElementById("msg").value = "";
    addBubble(msg, "user");
    meta.textContent = "Waiting for reply...";
    try {
      const out = await api("/chat", "POST", { user_message: msg, session_id: "default" });
      addBubble(out.assistant_message, "assistant");
      meta.textContent = `Mode=${out.mode} • Memory cards=${out.used_memory_cards.length}`;
    } catch (e) {
      addBubble("Backend error: " + e.message, "assistant");
      meta.textContent = "Request failed";
    }
  }

  // Send button click
  document.getElementById("send").onclick = sendMessage;

  // Input box keyboard event: Enter to send, Shift+Enter to newline
  document.getElementById("msg").onkeydown = (e) => {
    if (e.key === "Enter") {
      if (e.shiftKey) {
        // Shift+Enter: newline (default behavior)
        return;
      } else {
        // Enter: send
        e.preventDefault();
        sendMessage();
      }
    }
  };

  document.getElementById("clear").onclick = async () => {
    chatlog.innerHTML = "";
    meta.textContent = "Clearing...";
    try {
      await api("/clear-history", "POST", { session_id: "default" });
      meta.textContent = "Chat history cleared";
    } catch (e) {
      meta.textContent = "Frontend cleared, backend clear failed";
    }
  };

  loadSettings();

  // ==================== System Prompt Modal Window ====================
  const systemPromptModal = document.getElementById('system-prompt-modal');
  const openSystemPromptBtn = document.getElementById('open-system-prompt-window');
  const closeSystemPromptBtn = document.getElementById('close-system-prompt-modal');
  const systemPromptInput = document.getElementById('system-prompt-input');
  const customPromptName = document.getElementById('custom-prompt-name');
  const saveSystemPromptBtn = document.getElementById('save-system-prompt');
  const resetSystemPromptBtn = document.getElementById('reset-system-prompt');
  const systemPromptStatus = document.getElementById('system-prompt-status');
  const systemPromptTemplateSelect = document.getElementById('system-prompt-template-select');
  const templateStatus = document.getElementById('template-status');
  const customPromptSection = document.getElementById('custom-prompt-section');
  
  // 当前选中的模板内容和ID
  let currentTemplateContent = '';
  let lastSelectedTemplateId = 'custom'; // 默认为custom
  
  // 加载模板列表
  async function loadTemplatesList() {
    try {
      const data = await api('/settings/system-prompt/templates');
      const templates = data.templates || [];
      
      // Clear existing options (including custom)
      while (systemPromptTemplateSelect.options.length > 0) {
        systemPromptTemplateSelect.remove(0);
      }
      
      // Add template options first
      templates.forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = template.title;
        systemPromptTemplateSelect.appendChild(option);
      });
      
      // Add custom option at the end
      const customOption = document.createElement('option');
      customOption.value = 'custom';
      customOption.textContent = 'Custom (Create your own)';
      systemPromptTemplateSelect.appendChild(customOption);
      
      if (templates.length > 0) {
        templateStatus.textContent = `${templates.length} built-in personalities available`;
      }
    } catch (e) {
      templateStatus.textContent = 'Failed to load: ' + e.message;
    }
  }
  
  // 加载指定模板
  async function loadTemplateContent(templateId) {
    try {
      const data = await api(`/settings/system-prompt/templates/${templateId}`);
      
      if (data.status === 'success') {
        currentTemplateContent = data.content;
        systemPromptStatus.textContent = `Using: ${data.title}`;
        
        // 自动保存到backend
        await api('/settings/system-prompt', 'POST', {
          system_prompt: data.content
        });
        systemPromptStatus.textContent = `✓ Switched to: ${data.title}`;
      } else {
        systemPromptStatus.textContent = 'Error: ' + (data.error || 'Unknown error');
      }
    } catch (e) {
      systemPromptStatus.textContent = 'Failed to load: ' + e.message;
    }
  }
  
  // 监听模板选择变化
  systemPromptTemplateSelect.onchange = async () => {
    const templateId = systemPromptTemplateSelect.value;
    lastSelectedTemplateId = templateId;
    
    // 保存选择到本地存储
    localStorage.setItem('lastSelectedTemplateId', templateId);
    
    if (templateId === 'custom') {
      customPromptSection.style.display = 'block';
      currentTemplateContent = '';
      customPromptName.value = '';
      systemPromptStatus.textContent = '';
    } else {
      customPromptSection.style.display = 'none';
      await loadTemplateContent(templateId);
    }
  };
  
  // Open system prompt window
  openSystemPromptBtn.onclick = async () => {
    systemPromptModal.classList.add('show');
    await loadTemplatesList();
    await loadSystemPrompt();
  };
  
  // Close system prompt window
  closeSystemPromptBtn.onclick = () => {
    systemPromptModal.classList.remove('show');
  };
  
  // Click modal background to close
  systemPromptModal.onclick = (e) => {
    if (e.target === systemPromptModal) {
      systemPromptModal.classList.remove('show');
    }
  };
  
  // Load system prompt from settings
  async function loadSystemPrompt() {
    try {
      const data = await api('/settings/system-prompt');
      const savedPrompt = data.system_prompt || '';
      
      // 从本地存储恢复上次选择的模板ID
      const savedTemplateId = localStorage.getItem('lastSelectedTemplateId') || 'custom';
      lastSelectedTemplateId = savedTemplateId;
      
      if (savedPrompt) {
        systemPromptInput.value = savedPrompt;
      } else {
        systemPromptInput.value = '';
      }
      
      // 设置下拉框为上次选择的值
      systemPromptTemplateSelect.value = savedTemplateId;
      
      // 触发change事件来更新UI
      if (savedTemplateId === 'custom') {
        customPromptSection.style.display = 'block';
        systemPromptStatus.textContent = '';
      } else {
        customPromptSection.style.display = 'none';
        await loadTemplateContent(savedTemplateId);
      }
    } catch (e) {
      systemPromptStatus.textContent = 'Failed to load: ' + e.message;
    }
  }
  
  // Save system prompt
  saveSystemPromptBtn.onclick = async () => {
    try {
      const contentToSave = systemPromptInput.value.trim();
      
      if (!contentToSave) {
        systemPromptStatus.textContent = 'Cannot save empty prompt';
        return;
      }
      
      systemPromptStatus.textContent = 'Saving...';
      
      // 保存自定义人格
      const saveResponse = await api('/settings/system-prompt/save-custom', 'POST', {
        title: customPromptName.value.trim() || 'My Custom Personality',
        content: contentToSave
      });
      
      if (saveResponse.status === 'success') {
        const personalityId = saveResponse.personality_id;
        const personalityTitle = saveResponse.title;
        
        // 保存到settings
        await api('/settings/system-prompt', 'POST', {
          system_prompt: contentToSave
        });
        
        // 重新加载模板列表
        await loadTemplatesList();
        
        // 选中新保存的人格
        systemPromptTemplateSelect.value = personalityId;
        lastSelectedTemplateId = personalityId;
        localStorage.setItem('lastSelectedTemplateId', personalityId);
        
        // 隐藏自定义输入框
        customPromptSection.style.display = 'none';
        
        systemPromptStatus.textContent = `✓ Saved: ${personalityTitle}`;
      } else {
        systemPromptStatus.textContent = 'Error: ' + (saveResponse.error || 'Unknown error');
      }
    } catch (e) {
      systemPromptStatus.textContent = 'Failed to save: ' + e.message;
    }
  };
  
  // Reset system prompt
  resetSystemPromptBtn.onclick = () => {
    if (confirm('Clear custom personality?')) {
      systemPromptInput.value = '';
      customPromptName.value = '';
      systemPromptStatus.textContent = 'Cleared (not saved yet)';
    }
  };

  // ==================== Conversations Modal Window ====================
  const conversationsModal = document.getElementById('conversations-modal');
  const openConversationsBtn = document.getElementById('open-conversations-window');
  const closeConversationsBtn = document.getElementById('close-conversations-modal');
  const conversationSearch = document.getElementById('conversation-search');
  
  let conversationsList = [];
  let selectedConversationId = null;
  
  // Open conversations window
  openConversationsBtn.onclick = () => {
    conversationsModal.classList.add('show');
    loadConversationsList();
  };
  
  // Close conversations window
  closeConversationsBtn.onclick = () => {
    conversationsModal.classList.remove('show');
  };
  
  // Click modal background to close
  conversationsModal.onclick = (e) => {
    if (e.target === conversationsModal) {
      conversationsModal.classList.remove('show');
    }
  };
  
  // Search conversations
  let searchTimeout = null;
  conversationSearch.oninput = () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      loadConversationsList(conversationSearch.value.trim());
    }, 300);
  };
  
  // Load conversations list
  async function loadConversationsList(query = '') {
    const listEl = document.getElementById('conversation-list');
    const statusEl = document.getElementById('conversation-status');
    
    try {
      listEl.innerHTML = '<div class="muted" style="text-align:center; padding:30px;">Loading...</div>';
      
      const url = query ? `/conversations?query=${encodeURIComponent(query)}` : '/conversations';
      const data = await api(url);
      conversationsList = data.conversations || [];
      
      if (conversationsList.length === 0) {
        listEl.innerHTML = '<div class="muted" style="text-align:center; padding:30px;">No conversations found</div>';
        statusEl.textContent = '';
        return;
      }
      
      listEl.innerHTML = conversationsList.map(conv => `
        <div class="conversation-item" data-id="${conv.conversation_id}">
          <div class="conversation-title">${escapeHtml(conv.title)}</div>
          <div class="conversation-meta">
            <span>Messages: ${conv.message_count}</span>
            <span>${conv.update_time ? formatDate(conv.update_time) : 'Unknown date'}</span>
          </div>
        </div>
      `).join('');
      
      statusEl.textContent = `Found ${conversationsList.length} conversations`;
      
      // Add click handlers
      listEl.querySelectorAll('.conversation-item').forEach(item => {
        item.onclick = () => selectConversation(item.dataset.id);
      });
      
    } catch (e) {
      listEl.innerHTML = `<div class="muted" style="text-align:center; padding:30px;">Failed to load: ${e.message}</div>`;
      statusEl.textContent = 'Error loading conversations';
    }
  }
  
  // Format timestamp to readable date
  function formatDate(timestamp) {
    const date = new Date(timestamp * 1000);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  // Select and load a conversation
  async function selectConversation(conversationId) {
    const statusEl = document.getElementById('conversation-status');
    const listEl = document.getElementById('conversation-list');
    
    // Highlight selected item
    listEl.querySelectorAll('.conversation-item').forEach(item => {
      item.style.borderColor = item.dataset.id === conversationId 
        ? 'rgba(80,120,255,.6)' 
        : 'rgba(255,255,255,.08)';
    });
    
    try {
      statusEl.textContent = 'Loading conversation...';
      
      const data = await api(`/conversations/${conversationId}`);
      
      if (data.error) {
        statusEl.textContent = data.error;
        return;
      }
      
      selectedConversationId = conversationId;
      
      // Show preview of messages
      const selectedItem = listEl.querySelector(`[data-id="${conversationId}"]`);
      
      // Remove existing preview
      const existingPreview = listEl.querySelector('.conversation-preview');
      if (existingPreview) {
        existingPreview.remove();
      }
      
      // Add preview below selected item
      const previewHtml = `
        <div class="conversation-preview">
          <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <span class="muted">${data.messages.length} messages</span>
            <button id="load-to-chat" style="padding:6px 12px; font-size:12px; background:rgba(80,120,255,.3); border-color:rgba(80,120,255,.5);">Load to Chat</button>
          </div>
          ${data.messages.slice(0, 10).map(msg => `
            <div class="preview-message ${msg.role}">
              <div class="role">${msg.role}</div>
              <div>${escapeHtml(msg.content.substring(0, 300))}${msg.content.length > 300 ? '...' : ''}</div>
            </div>
          `).join('')}
          ${data.messages.length > 10 ? `<div class="muted" style="text-align:center; padding:10px;">... and ${data.messages.length - 10} more messages</div>` : ''}
        </div>
      `;
      
      selectedItem.insertAdjacentHTML('afterend', previewHtml);
      
      // Add load to chat handler
      document.getElementById('load-to-chat').onclick = () => {
        loadConversationToChat(data);
      };
      
      statusEl.textContent = `Loaded: ${data.title}`;
      
    } catch (e) {
      statusEl.textContent = `Failed to load: ${e.message}`;
    }
  }
  
  // Load conversation to main chat
  function loadConversationToChat(conversationData) {
    // Clear current chat
    chatlog.innerHTML = '';
    
    // Add messages to chat
    conversationData.messages.forEach(msg => {
      if (msg.role === 'user' || msg.role === 'assistant') {
        addBubble(msg.content, msg.role === 'user' ? 'user' : 'assistant');
      }
    });
    
    // Close modal
    conversationsModal.classList.remove('show');
    
    // Update meta
    meta.textContent = `Loaded conversation: ${conversationData.title} (${conversationData.messages.length} messages)`;
  }

  // ==================== Memory Modal Window ====================
  // Open/close handlers for memory modal window
  const memoryModal = document.getElementById('memory-modal');
  const openMemoryBtn = document.getElementById('open-memory-window');
  const closeMemoryBtn = document.getElementById('close-memory-modal');
  
  // Open memory window
  openMemoryBtn.onclick = () => {
    memoryModal.classList.add('show');
    loadPlugins();
    loadMemory();
  };
  
  // Close memory window
  closeMemoryBtn.onclick = () => {
    memoryModal.classList.remove('show');
  };
  
  // Click modal background to close
  memoryModal.onclick = (e) => {
    if (e.target === memoryModal) {
      memoryModal.classList.remove('show');
    }
  };
  
  // ESC key to close modals
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (memoryModal.classList.contains('show')) {
        memoryModal.classList.remove('show');
      }
      if (conversationsModal.classList.contains('show')) {
        conversationsModal.classList.remove('show');
      }
      if (systemPromptModal.classList.contains('show')) {
        systemPromptModal.classList.remove('show');
      }
    }
  });

  // ==================== Memory Plugin System ====================
  
  let currentPluginId = null;
  let availablePlugins = [];
  
  // Tab switching functionality
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab + '-tab').style.display = 'block';
    };
  });

  // Load available plugins list
  async function loadPlugins() {
    const select = document.getElementById('memory-plugin-select');
    const pluginInfo = document.getElementById('plugin-info');
    const pluginFeatures = document.getElementById('plugin-features');
    
    try {
      // Get available plugins
      const pluginsRes = await api("/memory/plugins");
      availablePlugins = pluginsRes.plugins || [];
      
      // Get currently active plugin
      const activeRes = await api("/memory/plugins/active");
      currentPluginId = activeRes.id;
      
      // Populate dropdown menu
      select.innerHTML = availablePlugins.map(p => 
        `<option value="${p.id}" ${p.id === currentPluginId ? 'selected' : ''}>${p.name}</option>`
      ).join('');
      
      // Display current plugin info
      updatePluginInfo(currentPluginId);
      
    } catch (e) {
      select.innerHTML = '<option value="">Failed to load</option>';
      pluginInfo.textContent = 'Unable to connect to backend';
    }
  }
  
  // Update plugin info display
  function updatePluginInfo(pluginId) {
    const plugin = availablePlugins.find(p => p.id === pluginId);
    const pluginInfo = document.getElementById('plugin-info');
    const pluginFeatures = document.getElementById('plugin-features');
    
    if (plugin) {
      pluginInfo.innerHTML = `
        <strong>${plugin.name}</strong> v${plugin.version}<br/>
        ${plugin.description}
      `;
      
      // Display feature tags
      const features = [];
      if (plugin.supports_vector_search) features.push('<span class="memory-tag" style="background:rgba(100,200,255,.2);">Vector Search</span>');
      if (plugin.supports_graph) features.push('<span class="memory-tag" style="background:rgba(255,200,100,.2);">Knowledge Graph</span>');
      if (plugin.supports_temporal) features.push('<span class="memory-tag" style="background:rgba(100,255,100,.2);">Temporal Retrieval</span>');
      
      pluginFeatures.innerHTML = features.join('');
    }
  }
  
  // Switch plugin handler
  document.getElementById('memory-plugin-select').onchange = async (e) => {
    const newPluginId = e.target.value;
    const memoryStatus = document.getElementById('memory-status');
    
    if (newPluginId && newPluginId !== currentPluginId) {
      try {
        memoryStatus.textContent = `Switching to ${newPluginId}...`;
        await api("/memory/plugins/switch", "POST", { plugin_id: newPluginId });
        currentPluginId = newPluginId;
        updatePluginInfo(newPluginId);
        memoryStatus.textContent = `Switched to ${availablePlugins.find(p => p.id === newPluginId)?.name || newPluginId}`;
        loadMemory();
      } catch (e) {
        memoryStatus.textContent = `Switch failed: ${e.message}`;
        // Restore selection
        document.getElementById('memory-plugin-select').value = currentPluginId;
      }
    }
  };

  // Load and display memories
  async function loadMemory() {
    const memoryList = document.getElementById('memory-list');
    const entityList = document.getElementById('entity-list');
    const relationList = document.getElementById('relation-list');
    const memoryStats = document.getElementById('memory-stats');
    
    try {
      // Use visualization API
      const data = await api("/memory/visualization");
      
      // Display memory list
      const memories = data.recent_memories || (data.memory_tree?.recent_memories) || [];
      
      if (memories.length > 0) {
        memoryList.innerHTML = memories.map(m => `
          <div class="memory-item">
            <div class="memory-content">${escapeHtml(m.content)}</div>
            <div class="importance-bar"><div class="importance-fill" style="width:${((m.effective_importance || m.importance) * 100).toFixed(0)}%"></div></div>
            <div class="memory-meta">
              <span>Date: ${new Date(m.timestamp).toLocaleString('en-US')}</span>
              <span>Importance: ${((m.effective_importance || m.importance) * 100).toFixed(0)}%</span>
              ${m.mention_count > 0 ? `<span>Mentions: ${m.mention_count}</span>` : ''}
            </div>
            <div style="margin-top:4px;">
              ${(m.emotion_tags || []).map(t => `<span class="memory-tag emotion">${t}</span>`).join('')}
              ${(m.topic_tags || []).map(t => `<span class="memory-tag topic">${t}</span>`).join('')}
            </div>
          </div>
        `).join('');
      } else {
        memoryList.innerHTML = '<div class="muted" style="text-align:center; padding:20px;">No memories found. Try adding demo data.</div>';
      }
      
      // Display entities (if plugin supports)
      const entities = data.knowledge_graph?.entities || [];
      const plugin = availablePlugins.find(p => p.id === currentPluginId);
      
      if (plugin?.supports_graph && entities.length > 0) {
        entityList.innerHTML = entities.map(e => `
          <div class="entity-item">
            <div class="entity-name">${escapeHtml(e.name)}</div>
            <div class="entity-type">${e.type} • Importance: ${(e.importance * 100).toFixed(0)}%</div>
          </div>
        `).join('');
      } else if (!plugin?.supports_graph) {
        entityList.innerHTML = '<div class="muted" style="text-align:center; padding:10px;">Current plugin does not support knowledge graph</div>';
      } else {
        entityList.innerHTML = '<div class="muted" style="text-align:center; padding:10px;">No entities found</div>';
      }
      
      // Display relationships
      const relationships = data.knowledge_graph?.relationships || [];
      if (relationships.length > 0) {
        relationList.innerHTML = relationships.map(r => `
          <div class="relation-item">
            <strong>${escapeHtml(r.source)}</strong> → <span style="opacity:0.7">${r.type}</span> → <strong>${escapeHtml(r.target)}</strong>
          </div>
        `).join('');
      } else {
        relationList.innerHTML = '<div class="muted" style="text-align:center; padding:10px;">No relationships</div>';
      }
      
      // Statistics info
      const stats = data.stats || {};
      const activePlugin = data.active_plugin || currentPluginId;
      const pluginName = availablePlugins.find(p => p.id === activePlugin)?.name || activePlugin;
      
      memoryStats.innerHTML = `
        <div class="stat-row"><span>Current Plugin</span><strong>${pluginName}</strong></div>
        <div class="stat-row"><span>Total Memories</span><strong>${stats.total_memories || memories.length}</strong></div>
        ${stats.total_entities ? `<div class="stat-row"><span>Entities</span><strong>${stats.total_entities}</strong></div>` : ''}
        ${stats.total_relationships ? `<div class="stat-row"><span>Relationships</span><strong>${stats.total_relationships}</strong></div>` : ''}
        ${stats.memory_by_importance ? `
          <div style="margin-top:8px; font-size:11px;">
            <div class="stat-row"><span>High Importance</span><span>${stats.memory_by_importance.high || 0}</span></div>
            <div class="stat-row"><span>Medium Importance</span><span>${stats.memory_by_importance.medium || 0}</span></div>
            <div class="stat-row"><span>Low Importance</span><span>${stats.memory_by_importance.low || 0}</span></div>
          </div>
        ` : ''}
        <div style="margin-top:8px; font-size:10px; opacity:0.5;">
          Available Plugins: ${(data.available_plugins || []).map(p => p.name).join(', ')}
        </div>
      `;
      
    } catch (e) {
      memoryList.innerHTML = `<div class="muted" style="text-align:center; padding:20px;">Failed to load: ${e.message}</div>`;
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  document.getElementById('refresh-memory').onclick = () => {
    loadPlugins();
    loadMemory();
  };

  // Add memory handler (supports newline-separated entries)
  document.getElementById('add-memory').onclick = async () => {
    const memoryStatus = document.getElementById('memory-status');
    const rawContent = document.getElementById('new-memory').value.trim();
    const tags = document.getElementById('memory-tags').value.trim();
    const importance = parseFloat(document.getElementById('memory-importance').value) || 0.5;
    
    if (!rawContent) {
      memoryStatus.textContent = 'Please enter memory content';
      return;
    }
    
    // Split content by newline
    const contents = rawContent
      .split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 0);
    
    if (contents.length === 0) {
      memoryStatus.textContent = 'Please enter memory content';
      return;
    }
    
    try {
      memoryStatus.textContent = `Adding ${contents.length} memories...`;
      const topicTags = tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [];
      
      let addedCount = 0;
      for (const content of contents) {
        await api("/memory/add", "POST", {
          content,
          importance,
          topic_tags: topicTags,
          emotion_tags: [],
          entities: []
        });
        addedCount++;
      }
      
      memoryStatus.textContent = `Added ${addedCount} memories`;
      document.getElementById('new-memory').value = '';
      document.getElementById('memory-tags').value = '';
      loadMemory();
    } catch (e) {
      memoryStatus.textContent = 'Failed to add: ' + e.message;
    }
  };

  // Add demo data handler
  document.getElementById('add-demo').onclick = async () => {
    const memoryStatus = document.getElementById('memory-status');
    try {
      memoryStatus.textContent = 'Adding demo data...';
      const result = await api("/memory/demo", "POST");
      memoryStatus.textContent = `Added ${result.added} demo memories`;
      loadMemory();
    } catch (e) {
      memoryStatus.textContent = 'Failed to add: ' + e.message;
    }
  };

  // Clear all memories handler
  document.getElementById('clear-memory').onclick = async () => {
    const memoryStatus = document.getElementById('memory-status');
    if (!confirm('Clear all memories for current plugin?')) return;
    
    try {
      memoryStatus.textContent = 'Clearing...';
      await api("/memory/clear", "POST");
      memoryStatus.textContent = 'Memories cleared';
      loadMemory();
    } catch (e) {
      memoryStatus.textContent = 'Failed to clear: ' + e.message;
    }
  };

  // Initialize on page load (load plugin list only, load memories when opened)
  setTimeout(() => {
    loadPlugins();
  }, 500);
</script>
</body>
</html>
