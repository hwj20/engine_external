<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' http://127.0.0.1:8787;
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data:;
                 connect-src 'self' http://127.0.0.1:8787;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AURORA Local Agent MVP</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background: #0b0f17; color: #e7eefc; }
    header { padding: 14px 18px; display:flex; align-items:center; justify-content:space-between; border-bottom: 1px solid rgba(255,255,255,.08); }
    .badge { font-size: 12px; opacity: .75; }
    .wrap { display:grid; grid-template-columns: 360px 1fr 360px; height: calc(100vh - 52px); }
    .panel { border-right: 1px solid rgba(255,255,255,.08); padding: 14px; overflow:auto; }
    .panel-right { border-left: 1px solid rgba(255,255,255,.08); border-right: none; padding: 14px; overflow:auto; }
    .main { padding: 14px; display:flex; flex-direction:column; gap:10px; }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 12px; }
    label { display:block; font-size: 12px; opacity: .85; margin-bottom: 6px; }
    input, textarea { width:100%; box-sizing:border-box; border-radius: 10px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.25); color:#e7eefc; padding: 10px; outline:none; }
    textarea { min-height: 90px; resize: vertical; }
    button { cursor:pointer; border-radius: 12px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.08); color:#e7eefc; padding: 10px 12px; }
    button:hover { background: rgba(255,255,255,.12); }
    .chatlog { flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; }
    .bubble { padding: 10px 12px; border-radius: 14px; border:1px solid rgba(255,255,255,.10); white-space: pre-wrap; }
    .u { background: rgba(80,120,255,.12); align-self:flex-end; max-width: 76%; }
    .a { background: rgba(255,255,255,.06); align-self:flex-start; max-width: 76%; }
    .muted { opacity:.75; font-size:12px; }
    
    /* Memory Panel Styles */
    .memory-item { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.06); border-radius: 10px; padding: 10px; margin-bottom: 8px; transition: all 0.2s; }
    .memory-item:hover { background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.12); }
    .memory-content { font-size: 13px; margin-bottom: 6px; line-height: 1.4; }
    .memory-meta { font-size: 11px; opacity: 0.6; display: flex; gap: 8px; flex-wrap: wrap; }
    .memory-tag { background: rgba(80,120,255,.2); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
    .memory-tag.emotion { background: rgba(255,100,100,.2); }
    .memory-tag.topic { background: rgba(100,200,100,.2); }
    .entity-item { background: rgba(255,200,100,.1); border: 1px solid rgba(255,200,100,.2); border-radius: 8px; padding: 8px; margin-bottom: 6px; }
    .entity-name { font-weight: 600; font-size: 13px; }
    .entity-type { font-size: 11px; opacity: 0.6; }
    .relation-item { font-size: 12px; padding: 6px 8px; background: rgba(100,200,255,.1); border-radius: 6px; margin-bottom: 4px; }
    .tab-buttons { display: flex; gap: 6px; margin-bottom: 10px; }
    .tab-btn { flex: 1; text-align: center; padding: 8px; border-radius: 8px; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); cursor: pointer; font-size: 12px; }
    .tab-btn.active { background: rgba(80,120,255,.2); border-color: rgba(80,120,255,.4); }
    .stat-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,.06); font-size: 12px; }
    .importance-bar { height: 4px; background: rgba(255,255,255,.1); border-radius: 2px; overflow: hidden; margin-top: 4px; }
    .importance-fill { height: 100%; background: linear-gradient(90deg, #4080ff, #80c0ff); }
  </style>
</head>
<body>
  <header>
    <div>
      <div style="font-weight:700;">AURORA Local Agent MVP</div>
      <div class="badge">Local-only â€¢ Backend: 127.0.0.1:8787 â€¢ Version <span id="ver"></span></div>
    </div>
    <div class="badge">æç¤ºï¼šå…ˆå¯åŠ¨ backendï¼Œå†æ‰“å¼€èŠå¤©ã€‚</div>
  </header>

  <div class="wrap">
    <aside class="panel">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" id="settings-toggle">
          <div style="font-weight:700;">âš™ï¸ Settings</div>
          <span id="settings-arrow">â–¼</span>
        </div>
        <div id="settings-content" style="display:none; margin-top:10px;">
          <div class="muted" style="margin-bottom:10px;">å¡«å…¥ OpenAI-compatible çš„ base_url / api_key / modelï¼ˆåªå­˜æœ¬åœ°ï¼‰ã€‚</div>

          <label>Base URL (e.g. https://api.openai.com)</label>
          <input id="base_url" placeholder="https://api.openai.com" />

          <label style="margin-top:10px;">API Keyï¼ˆç•™ç©ºåˆ™ä¿ç•™åŸæœ‰ keyï¼‰</label>
          <input id="api_key" type="password" placeholder="ç•™ç©ºåˆ™ä¸æ›´æ–°" />

          <label style="margin-top:10px;">Model</label>
          <select id="model" style="width:100%; box-sizing:border-box; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:#e7eefc; padding:10px;">
            <option value="">-- é€‰æ‹©æ¨¡å‹ --</option>
            <optgroup label="OpenAI">
              <option value="gpt-4o">gpt-4o</option>
              <option value="gpt-4o-mini">gpt-4o-mini</option>
              <option value="gpt-4-turbo">gpt-4-turbo</option>
              <option value="gpt-4">gpt-4</option>
              <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
            </optgroup>
            <optgroup label="Claude">
              <option value="claude-3-opus-20240229">claude-3-opus</option>
              <option value="claude-3-sonnet-20240229">claude-3-sonnet</option>
              <option value="claude-3-haiku-20240307">claude-3-haiku</option>
              <option value="claude-3-5-sonnet-20241022">claude-3.5-sonnet</option>
            </optgroup>
            <optgroup label="DeepSeek">
              <option value="deepseek-chat">deepseek-chat</option>
              <option value="deepseek-reasoner">deepseek-reasoner</option>
            </optgroup>
            <optgroup label="å…¶ä»–">
              <option value="custom">è‡ªå®šä¹‰...</option>
            </optgroup>
          </select>
          <input id="model_custom" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°" style="display:none; margin-top:6px;" />

          <div style="display:flex; gap:10px; margin-top:12px;">
            <button id="save">Save All</button>
            <button id="save-model">ä»…æ›´æ–°æ¨¡å‹</button>
            <button id="health">Health</button>
          </div>
        </div>
        <div id="status" class="muted" style="margin-top:10px;"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="font-weight:700; margin-bottom:8px;">Cost Controls</div>
        <div class="muted">è¾“å‡ºé•¿åº¦ç¡¬é™åˆ¶ï¼šChatâ‰ˆ220 tokensï¼ŒTaskâ‰ˆ400 tokensï¼›ä¸Šä¸‹æ–‡é¢„ç®—â‰ˆ2200 tokensï¼ˆå­—ç¬¦è¿‘ä¼¼ï¼‰ã€‚</div>
      </div>
    </aside>

    <main class="main">
      <div class="chatlog" id="chatlog"></div>

      <div class="card">
        <label>Message</label>
        <textarea id="msg" placeholder="è·Ÿæˆ‘è¯´ç‚¹ä»€ä¹ˆâ€¦ï¼ˆå…ˆå¯åŠ¨ backendï¼‰"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button id="send">Send</button>
          <button id="clear">Clear</button>
        </div>
        <div id="meta" class="muted" style="margin-top:10px;"></div>
      </div>
    </main>

    <!-- Memory Panel -->
    <aside class="panel-right">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div style="font-weight:700;">ğŸ§  Memory</div>
          <button id="refresh-memory" style="padding:6px 10px; font-size:11px;">åˆ·æ–°</button>
        </div>
        
        <div class="tab-buttons">
          <div class="tab-btn active" data-tab="memories">è®°å¿†</div>
          <div class="tab-btn" data-tab="entities">å®ä½“</div>
          <div class="tab-btn" data-tab="stats">ç»Ÿè®¡</div>
        </div>

        <!-- è®°å¿†åˆ—è¡¨ -->
        <div id="memories-tab" class="tab-content">
          <div id="memory-list" style="max-height: 400px; overflow:auto;">
            <div class="muted" style="text-align:center; padding:20px;">ç‚¹å‡»åˆ·æ–°åŠ è½½è®°å¿†...</div>
          </div>
        </div>

        <!-- å®ä½“åˆ—è¡¨ -->
        <div id="entities-tab" class="tab-content" style="display:none;">
          <div id="entity-list" style="max-height: 300px; overflow:auto;">
            <div class="muted" style="text-align:center; padding:20px;">æš‚æ— å®ä½“...</div>
          </div>
          <div style="margin-top:10px;">
            <div style="font-weight:600; font-size:12px; margin-bottom:6px;">å…³ç³»ç½‘ç»œ</div>
            <div id="relation-list" style="max-height: 150px; overflow:auto;">
              <div class="muted" style="text-align:center; padding:10px;">æš‚æ— å…³ç³»...</div>
            </div>
          </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div id="stats-tab" class="tab-content" style="display:none;">
          <div id="memory-stats">
            <div class="muted" style="text-align:center; padding:20px;">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="font-weight:700; margin-bottom:8px;">æ·»åŠ è®°å¿†</div>
        <textarea id="new-memory" placeholder="è¾“å…¥è¦æ·»åŠ çš„è®°å¿†å†…å®¹..." style="min-height:60px;"></textarea>
        <div style="display:flex; gap:6px; margin-top:8px;">
          <input id="memory-tags" placeholder="æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰" style="flex:1;" />
          <input id="memory-importance" type="number" min="0" max="1" step="0.1" value="0.5" style="width:60px;" />
        </div>
        <div style="display:flex; gap:6px; margin-top:8px;">
          <button id="add-memory" style="flex:1;">æ·»åŠ è®°å¿†</button>
          <button id="add-demo" style="flex:1;">æ·»åŠ æ¼”ç¤ºæ•°æ®</button>
        </div>
        <div id="memory-status" class="muted" style="margin-top:8px;"></div>
      </div>
    </aside>
  </div>

<script>
  document.getElementById("ver").textContent = (window.aurora && window.aurora.version) ? window.aurora.version : "0.1.0";
  const chatlog = document.getElementById("chatlog");
  const status = document.getElementById("status");
  const meta = document.getElementById("meta");

  // Settings æŠ˜å /å±•å¼€
  document.getElementById("settings-toggle").onclick = () => {
    const content = document.getElementById("settings-content");
    const arrow = document.getElementById("settings-arrow");
    if (content.style.display === "none") {
      content.style.display = "block";
      arrow.textContent = "â–²";
    } else {
      content.style.display = "none";
      arrow.textContent = "â–¼";
    }
  };

  function addBubble(text, who) {
    const div = document.createElement("div");
    div.className = "bubble " + (who === "user" ? "u" : "a");
    div.textContent = text;
    chatlog.appendChild(div);
    chatlog.scrollTop = chatlog.scrollHeight;
  }

  async function api(path, method="GET", body=null) {
    const url = "http://127.0.0.1:8787" + path;
    const opt = { method, headers: { "Content-Type": "application/json" } };
    if (body) opt.body = JSON.stringify(body);
    const res = await fetch(url, opt);
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function loadSettings() {
    try {
      const s = await api("/settings");
      document.getElementById("base_url").value = s.base_url || "";
      document.getElementById("api_key").value = "";
      // è®¾ç½®æ¨¡å‹ä¸‹æ‹‰èœå•
      const modelSelect = document.getElementById("model");
      const modelCustom = document.getElementById("model_custom");
      const savedModel = s.model || "";
      // æ£€æŸ¥æ˜¯å¦æ˜¯é¢„è®¾æ¨¡å‹
      let found = false;
      for (let opt of modelSelect.options) {
        if (opt.value === savedModel) {
          modelSelect.value = savedModel;
          found = true;
          break;
        }
      }
      if (!found && savedModel) {
        modelSelect.value = "custom";
        modelCustom.style.display = "block";
        modelCustom.value = savedModel;
      }
      status.textContent = "âœ… å·²åŠ è½½è®¾ç½® (api_key å·²éšè—)";
    } catch (e) {
      status.textContent = "âŒ åç«¯æœªè¿æ¥ï¼Œè¯·å…ˆå¯åŠ¨åç«¯";
    }
  }

  // æ¨¡å‹ä¸‹æ‹‰èœå•ï¼šé€‰æ‹©"è‡ªå®šä¹‰"æ—¶æ˜¾ç¤ºè¾“å…¥æ¡†
  document.getElementById("model").onchange = () => {
    const modelSelect = document.getElementById("model");
    const modelCustom = document.getElementById("model_custom");
    if (modelSelect.value === "custom") {
      modelCustom.style.display = "block";
      modelCustom.focus();
    } else {
      modelCustom.style.display = "none";
      modelCustom.value = "";
    }
  };

  // è·å–å½“å‰é€‰æ‹©çš„æ¨¡å‹
  function getSelectedModel() {
    const modelSelect = document.getElementById("model");
    const modelCustom = document.getElementById("model_custom");
    if (modelSelect.value === "custom") {
      return modelCustom.value.trim();
    }
    return modelSelect.value;
  }

  document.getElementById("save").onclick = async () => {
    const status = document.getElementById("status");
    try {
      const base_url = document.getElementById("base_url").value.trim();
      const api_key = document.getElementById("api_key").value.trim();
      const model = getSelectedModel();
      if (!base_url || !model) {
        status.textContent = "âŒ è¯·å¡«å…¥ Base URL å’Œ Model";
        return;
      }
      status.textContent = "â³ ä¿å­˜ä¸­...";
      // å¦‚æœ api_key ä¸ºç©ºï¼Œå…ˆè·å–æ—§çš„
      let finalApiKey = api_key;
      if (!finalApiKey) {
        const old = await api("/settings");
        finalApiKey = old.api_key === "********" ? "" : old.api_key;
        if (!finalApiKey) {
          // éœ€è¦ä»åç«¯è·å–çœŸå®keyï¼Œè¿™é‡Œç”¨ç‰¹æ®Šå¤„ç†
          status.textContent = "âŒ é¦–æ¬¡è®¾ç½®éœ€è¦å¡«å…¥ API Key";
          return;
        }
      }
      await api("/settings", "POST", { base_url, api_key: finalApiKey || api_key, model, provider: "openai_compatible" });
      status.textContent = "âœ… å…¨éƒ¨ä¿å­˜æˆåŠŸï¼";
    } catch (e) {
      status.textContent = "âŒ ä¿å­˜å¤±è´¥: " + e.message;
    }
  };

  document.getElementById("save-model").onclick = async () => {
    const status = document.getElementById("status");
    try {
      const model = getSelectedModel();
      if (!model) {
        status.textContent = "âŒ è¯·é€‰æ‹©æ¨¡å‹";
        return;
      }
      status.textContent = "â³ æ›´æ–°æ¨¡å‹ä¸­...";
      await api("/settings/model", "POST", { model });
      status.textContent = "âœ… æ¨¡å‹å·²æ›´æ–°ä¸º: " + model;
    } catch (e) {
      status.textContent = "âŒ æ›´æ–°æ¨¡å‹å¤±è´¥: " + e.message;
    }
  };

  document.getElementById("health").onclick = async () => {
    const status = document.getElementById("status");
    try {
      status.textContent = "â³ æ£€æŸ¥ä¸­...";
      const result = await api("/health");
      status.textContent = "âœ… åç«¯æ­£å¸¸: " + JSON.stringify(result);
    } catch (e) {
      status.textContent = "âŒ åç«¯è¿æ¥å¤±è´¥: " + e.message;
    }
  };

  // å‘é€æ¶ˆæ¯å‡½æ•°
  async function sendMessage() {
    const msg = document.getElementById("msg").value.trim();
    if (!msg) return;
    document.getElementById("msg").value = "";
    addBubble(msg, "user");
    meta.textContent = "â³ ç­‰å¾…å›å¤...";
    try {
      const out = await api("/chat", "POST", { user_message: msg, session_id: "default" });
      addBubble(out.assistant_message, "assistant");
      meta.textContent = `âœ… æ¨¡å¼=${out.mode} â€¢ å†…å­˜å¡ç‰‡=${out.used_memory_cards.length}`;
    } catch (e) {
      addBubble("âŒ åç«¯é”™è¯¯: " + e.message, "assistant");
      meta.textContent = "âŒ è¯·æ±‚å¤±è´¥";
    }
  }

  // Send æŒ‰é’®ç‚¹å‡»
  document.getElementById("send").onclick = sendMessage;

  // è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶ï¼šEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
  document.getElementById("msg").onkeydown = (e) => {
    if (e.key === "Enter") {
      if (e.shiftKey) {
        // Shift+Enterï¼šæ¢è¡Œï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
        return;
      } else {
        // Enterï¼šå‘é€
        e.preventDefault();
        sendMessage();
      }
    }
  };

  document.getElementById("clear").onclick = async () => {
    chatlog.innerHTML = "";
    meta.textContent = "â³ æ¸…ç©ºä¸­...";
    try {
      await api("/clear-history", "POST", { session_id: "default" });
      meta.textContent = "âœ… å¯¹è¯å†å²å·²æ¸…ç©º";
    } catch (e) {
      meta.textContent = "âš ï¸ å‰ç«¯å·²æ¸…ç©ºï¼Œä½†åç«¯å†å²æ¸…ç©ºå¤±è´¥";
    }
  };

  loadSettings();

  // ==================== Memory Panel ====================
  
  // Tab åˆ‡æ¢
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab + '-tab').style.display = 'block';
    };
  });

  // åˆ·æ–°è®°å¿†
  async function loadMemory() {
    const memoryList = document.getElementById('memory-list');
    const entityList = document.getElementById('entity-list');
    const relationList = document.getElementById('relation-list');
    const memoryStats = document.getElementById('memory-stats');
    
    try {
      // åŠ è½½è®°å¿†æ ‘
      const tree = await api("/memory/tree");
      
      if (tree.recent_memories && tree.recent_memories.length > 0) {
        memoryList.innerHTML = tree.recent_memories.map(m => `
          <div class="memory-item">
            <div class="memory-content">${escapeHtml(m.content)}</div>
            <div class="importance-bar"><div class="importance-fill" style="width:${(m.effective_importance * 100).toFixed(0)}%"></div></div>
            <div class="memory-meta">
              <span>ğŸ“… ${new Date(m.timestamp).toLocaleString('zh-CN')}</span>
              <span>â­ ${(m.effective_importance * 100).toFixed(0)}%</span>
              ${m.mention_count > 0 ? `<span>ğŸ’¬ ${m.mention_count}æ¬¡</span>` : ''}
            </div>
            <div style="margin-top:4px;">
              ${m.emotion_tags.map(t => `<span class="memory-tag emotion">${t}</span>`).join('')}
              ${m.topic_tags.map(t => `<span class="memory-tag topic">${t}</span>`).join('')}
            </div>
          </div>
        `).join('');
      } else {
        memoryList.innerHTML = '<div class="muted" style="text-align:center; padding:20px;">æš‚æ— è®°å¿†ï¼Œè¯•è¯•æ·»åŠ æ¼”ç¤ºæ•°æ®</div>';
      }
      
      // åŠ è½½çŸ¥è¯†å›¾è°±
      const graph = await api("/memory/graph");
      
      if (graph.entities && graph.entities.length > 0) {
        entityList.innerHTML = graph.entities.map(e => `
          <div class="entity-item">
            <div class="entity-name">${escapeHtml(e.name)}</div>
            <div class="entity-type">${e.type} â€¢ é‡è¦åº¦: ${(e.importance * 100).toFixed(0)}% â€¢ æåŠ: ${e.mention_count}æ¬¡</div>
          </div>
        `).join('');
      } else {
        entityList.innerHTML = '<div class="muted" style="text-align:center; padding:10px;">æš‚æ— å®ä½“</div>';
      }
      
      if (graph.relationships && graph.relationships.length > 0) {
        relationList.innerHTML = graph.relationships.map(r => `
          <div class="relation-item">
            <strong>${escapeHtml(r.source)}</strong> â†’ <span style="opacity:0.7">${r.type}</span> â†’ <strong>${escapeHtml(r.target)}</strong>
            ${r.description ? `<div class="muted">${escapeHtml(r.description)}</div>` : ''}
          </div>
        `).join('');
      } else {
        relationList.innerHTML = '<div class="muted" style="text-align:center; padding:10px;">æš‚æ— å…³ç³»</div>';
      }
      
      // ç»Ÿè®¡ä¿¡æ¯
      memoryStats.innerHTML = `
        <div class="stat-row"><span>æ€»è®°å¿†æ•°</span><strong>${tree.total_memories}</strong></div>
        <div class="stat-row"><span>å®ä½“æ•°</span><strong>${graph.total_entities}</strong></div>
        <div class="stat-row"><span>å…³ç³»æ•°</span><strong>${graph.total_relationships}</strong></div>
        ${Object.entries(graph.entities_by_type || {}).map(([k, v]) => 
          `<div class="stat-row"><span>- ${k}</span><span>${v}</span></div>`
        ).join('')}
        <div style="margin-top:10px; font-size:11px; opacity:0.6;">
          ${tree.years.map(y => `${y.year}: ${y.months.length}ä¸ªæœˆ`).join(' | ') || 'æš‚æ— æ—¶é—´æ•°æ®'}
        </div>
      `;
      
    } catch (e) {
      memoryList.innerHTML = `<div class="muted" style="text-align:center; padding:20px;">âŒ åŠ è½½å¤±è´¥: ${e.message}</div>`;
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  document.getElementById('refresh-memory').onclick = loadMemory;

  // æ·»åŠ è®°å¿†
  document.getElementById('add-memory').onclick = async () => {
    const memoryStatus = document.getElementById('memory-status');
    const content = document.getElementById('new-memory').value.trim();
    const tags = document.getElementById('memory-tags').value.trim();
    const importance = parseFloat(document.getElementById('memory-importance').value) || 0.5;
    
    if (!content) {
      memoryStatus.textContent = 'âŒ è¯·è¾“å…¥è®°å¿†å†…å®¹';
      return;
    }
    
    try {
      memoryStatus.textContent = 'â³ æ·»åŠ ä¸­...';
      const topicTags = tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [];
      
      await api("/memory/add", "POST", {
        content,
        importance,
        topic_tags: topicTags,
        emotion_tags: [],
        entities: []
      });
      
      memoryStatus.textContent = 'âœ… è®°å¿†å·²æ·»åŠ ';
      document.getElementById('new-memory').value = '';
      document.getElementById('memory-tags').value = '';
      loadMemory();
    } catch (e) {
      memoryStatus.textContent = 'âŒ æ·»åŠ å¤±è´¥: ' + e.message;
    }
  };

  // æ·»åŠ æ¼”ç¤ºæ•°æ®
  document.getElementById('add-demo').onclick = async () => {
    const memoryStatus = document.getElementById('memory-status');
    try {
      memoryStatus.textContent = 'â³ æ·»åŠ æ¼”ç¤ºæ•°æ®...';
      const result = await api("/memory/demo", "POST");
      memoryStatus.textContent = `âœ… å·²æ·»åŠ  ${result.added} æ¡æ¼”ç¤ºè®°å¿†`;
      loadMemory();
    } catch (e) {
      memoryStatus.textContent = 'âŒ æ·»åŠ å¤±è´¥: ' + e.message;
    }
  };

  // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è®°å¿†
  setTimeout(loadMemory, 500);
</script>
</body>
</html>
